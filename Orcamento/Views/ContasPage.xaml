<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Orcamento.ViewModels"
             xmlns:models="clr-namespace:Orcamento.Models"
             x:Class="Orcamento.Views.ContasPage"
             x:DataType="vm:ContasViewModel"
             Title="Minhas Contas"
             BackgroundColor="#F5F5F7">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Nova Conta"
                     IconImageSource="add.png"
                     Command="{Binding NovaContaCommand}"/>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*">

        <!-- Header com Resumo -->
        <Frame Grid.Row="0"
               Margin="20,20,20,0"
               Padding="24"
               CornerRadius="20"
               HasShadow="True">
            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                <VerticalStackLayout Grid.Column="0" Spacing="8">
                    <Label Text="💰 Saldo Total"
                           FontSize="16"
                           TextColor="#8E8E93"/>
                    <Label Text="{Binding SaldoTotalFormatado}"
                           FontSize="36"
                           FontAttributes="Bold"
                           TextColor="#1C1C1E"/>
                </VerticalStackLayout>

                <Frame Grid.Column="1"
                       Grid.RowSpan="2"
                       WidthRequest="80"
                       HeightRequest="80"
                       CornerRadius="40"
                       Padding="0"
                       BackgroundColor="#667eea"
                       VerticalOptions="Center">
                    <Label Text="{Binding TotalContas}"
                           FontSize="32"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </Frame>

                <Label Grid.Column="0"
                       Grid.Row="1"
                       Text="{Binding TotalContas, StringFormat='{0} contas ativas'}"
                       FontSize="14"
                       TextColor="#8E8E93"/>
            </Grid>
        </Frame>

        <!-- Lista de Contas -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}"
                     RefreshColor="#667eea"
                     Margin="20,16,20,20">
            <CollectionView ItemsSource="{Binding Contas}"
                           SelectionMode="Single"
                           SelectionChanged="OnContaSelecionada">
                <CollectionView.EmptyView>
                    <VerticalStackLayout Padding="40"
                                        Spacing="16"
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center">
                        <Label Text="🏦"
                               FontSize="80"
                               HorizontalOptions="Center"/>
                        <Label Text="Nenhuma conta cadastrada"
                               FontSize="20"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               TextColor="#1C1C1E"/>
                        <Label Text="Adicione sua primeira conta bancária, poupança ou carteira digital"
                               FontSize="14"
                               HorizontalOptions="Center"
                               TextColor="#8E8E93"
                               HorizontalTextAlignment="Center"
                               MaximumWidthRequest="300"/>
                        <Button Text="➕ Adicionar Conta"
                                Command="{Binding NovaContaCommand}"
                                BackgroundColor="#667eea"
                                TextColor="White"
                                CornerRadius="12"
                                Padding="24,12"
                                Margin="0,16,0,0"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="12"/>
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Conta">
                        <SwipeView>
                            <!-- Opções de Swipe -->
                            <SwipeView.LeftItems>
                                <SwipeItems>
                                    <SwipeItem Text="Ajustar $"
                                              BackgroundColor="#34C759"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ContasViewModel}}, Path=AjustarSaldoCommand}"
                                              CommandParameter="{Binding .}"/>
                                </SwipeItems>
                            </SwipeView.LeftItems>

                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Editar"
                                              BackgroundColor="#667eea"
                                              IconImageSource="edit.png"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ContasViewModel}}, Path=EditarContaCommand}"
                                              CommandParameter="{Binding .}"/>
                                    <SwipeItem Text="Excluir"
                                              BackgroundColor="#FF3B30"
                                              IconImageSource="delete.png"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ContasViewModel}}, Path=ExcluirContaCommand}"
                                              CommandParameter="{Binding .}"/>
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <!-- Card da Conta -->
                            <Frame Padding="20"
                                   CornerRadius="16"
                                   HasShadow="True"
                                   BackgroundColor="White">
                                <Grid ColumnDefinitions="64,*,Auto"
                                      ColumnSpacing="16"
                                      RowDefinitions="Auto,Auto">

                                    <!-- Ícone -->
                                    <Frame Grid.Column="0"
                                           Grid.RowSpan="2"
                                           WidthRequest="64"
                                           HeightRequest="64"
                                           CornerRadius="16"
                                           Padding="0"
                                           HasShadow="False"
                                           BackgroundColor="#667eea">
                                        <Label Text="{Binding TipoIcone}"
                                               FontSize="32"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"/>
                                    </Frame>

                                    <!-- Nome e Banco -->
                                    <VerticalStackLayout Grid.Column="1"
                                                        Grid.Row="0"
                                                        Spacing="4">
                                        <Label Text="{Binding Nome}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="#1C1C1E"/>
                                        <Label Text="{Binding BancoEAgencia}"
                                               FontSize="13"
                                               TextColor="#8E8E93"/>
                                    </VerticalStackLayout>

                                    <!-- Saldo -->
                                    <VerticalStackLayout Grid.Column="2"
                                                        Grid.Row="0"
                                                        Spacing="4"
                                                        HorizontalOptions="End">
                                        <Label Text="{Binding SaldoFormatado}"
                                               FontSize="20"
                                               FontAttributes="Bold"
                                               TextColor="#667eea"
                                               HorizontalOptions="End"/>
                                        <Label Text="{Binding TipoConta}"
                                               FontSize="11"
                                               TextColor="#8E8E93"
                                               HorizontalOptions="End"/>
                                    </VerticalStackLayout>

                                    <!-- Tags -->
                                    <HorizontalStackLayout Grid.Column="1"
                                                          Grid.ColumnSpan="2"
                                                          Grid.Row="1"
                                                          Spacing="8"
                                                          Margin="0,12,0,0">
                                        <Frame Padding="8,4"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               BackgroundColor="#F2F2F7"
                                               IsVisible="{Binding Ativa}">
                                            <Label Text="✓ Ativa"
                                                   FontSize="11"
                                                   TextColor="#34C759"/>
                                        </Frame>

                                        <Frame Padding="8,4"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               BackgroundColor="#F2F2F7"
                                               IsVisible="{Binding IncluirNoTotal}">
                                            <Label Text="💰 Incluída no total"
                                                   FontSize="11"
                                                   TextColor="#667eea"/>
                                        </Frame>

                                        <Frame Padding="8,4"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               BackgroundColor="#FFF3CD"
                                               IsVisible="{Binding Ativa, Converter={StaticResource InvertedBoolConverter}}">
                                            <Label Text="⚠ Inativa"
                                                   FontSize="11"
                                                   TextColor="#FF9500"/>
                                        </Frame>
                                    </HorizontalStackLayout>
                                </Grid>
                            </Frame>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1"
                          IsRunning="{Binding IsLoading}"
                          IsVisible="{Binding IsLoading}"
                          Color="#667eea"
                          HeightRequest="60"/>

        <!-- Botão Flutuante -->
        <Button Grid.Row="1"
                Text="➕"
                FontSize="32"
                WidthRequest="64"
                HeightRequest="64"
                CornerRadius="32"
                BackgroundColor="#667eea"
                TextColor="White"
                Command="{Binding NovaContaCommand}"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="0,0,20,20"
                Shadow="{StaticResource ButtonShadow}"/>
    </Grid>
</ContentPage>
