<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.Maui;assembly=LiveChartsCore.SkiaSharpView.Maui"
             xmlns:vm="clr-namespace:Orcamento.ViewModels"
             xmlns:models="clr-namespace:Orcamento.Models"
             xmlns:views="clr-namespace:Orcamento.Views"
             x:Class="Orcamento.Views.DashboardEnhancedPage"
             x:DataType="vm:DashboardEnhancedViewModel"
             Title="Dashboard"
             BackgroundColor="#F5F5F7">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Gradientes -->
            <LinearGradientBrush x:Key="PrimaryGradient" StartPoint="0,0" EndPoint="1,1">
                <GradientStop Color="#667eea" Offset="0.0" />
                <GradientStop Color="#764ba2" Offset="1.0" />
            </LinearGradientBrush>

            <LinearGradientBrush x:Key="GreenGradient" StartPoint="0,0" EndPoint="1,1">
                <GradientStop Color="#34C759" Offset="0.0" />
                <GradientStop Color="#30D158" Offset="1.0" />
            </LinearGradientBrush>

            <LinearGradientBrush x:Key="RedGradient" StartPoint="0,0" EndPoint="1,1">
                <GradientStop Color="#FF3B30" Offset="0.0" />
                <GradientStop Color="#FF6259" Offset="1.0" />
            </LinearGradientBrush>

            <!-- Animações -->
            <Style x:Key="FadeInStyle" TargetType="Frame">
                <Setter Property="Opacity" Value="0"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <RefreshView IsRefreshing="{Binding IsRefreshing}"
                 Command="{Binding RefreshCommand}"
                 RefreshColor="#667eea">
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="24">

                  <!-- Header com saudação e indicador de sync -->
                  <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                      <VerticalStackLayout Spacing="8">
                       <Label Text="Olá! 👋"
                           FontSize="32"
                           FontAttributes="Bold"
                           TextColor="#1C1C1E"/>
                       <Label Text="{Binding MesAtual}"
                           FontSize="16"
                           TextColor="#8E8E93"/>
                      </VerticalStackLayout>

                      <views:SyncIndicatorView Grid.Column="1"
                                    HorizontalOptions="End"
                                    VerticalOptions="Center"
                                    Margin="0,0,0,8"/>
                  </Grid>

                <!-- Card Principal: Saldo Total -->
                <Frame Background="{StaticResource PrimaryGradient}"
                       CornerRadius="20"
                       Padding="24"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="12">
                        <Label Text="💰 Saldo Total"
                               TextColor="White"
                               FontSize="18"
                               Opacity="0.9"
                               FontAttributes="Bold"/>
                        <Label Text="{Binding SaldoTotalFormatado}"
                               TextColor="White"
                               FontSize="42"
                               FontAttributes="Bold"/>
                        <HorizontalStackLayout Spacing="20" Margin="0,8,0,0">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="Receitas"
                                       TextColor="White"
                                       FontSize="12"
                                       Opacity="0.8"/>
                                <Label Text="{Binding ReceitasMesFormatado}"
                                       TextColor="White"
                                       FontSize="16"
                                       FontAttributes="Bold"/>
                            </VerticalStackLayout>
                            <BoxView WidthRequest="1"
                                    HeightRequest="40"
                                    Color="White"
                                    Opacity="0.3"/>
                            <VerticalStackLayout Spacing="4">
                                <Label Text="Despesas"
                                       TextColor="White"
                                       FontSize="12"
                                       Opacity="0.8"/>
                                <Label Text="{Binding DespesasMesFormatado}"
                                       TextColor="White"
                                       FontSize="16"
                                       FontAttributes="Bold"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <!-- Cards de Resumo: Receitas e Despesas -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="16">

                    <!-- Receitas -->
                    <Frame Grid.Column="0"
                           Background="{StaticResource GreenGradient}"
                           CornerRadius="16"
                           Padding="20"
                           HasShadow="True">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="📥"
                                   FontSize="32"/>
                            <Label Text="Receitas"
                                   TextColor="White"
                                   FontSize="14"
                                   Opacity="0.9"/>
                            <Label Text="{Binding ReceitasMesFormatado}"
                                   TextColor="White"
                                   FontSize="22"
                                   FontAttributes="Bold"/>
                            <Label Text="+15% vs mês anterior"
                                   TextColor="White"
                                   FontSize="11"
                                   Opacity="0.7"/>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Despesas -->
                    <Frame Grid.Column="1"
                           Background="{StaticResource RedGradient}"
                           CornerRadius="16"
                           Padding="20"
                           HasShadow="True">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="📤"
                                   FontSize="32"/>
                            <Label Text="Despesas"
                                   TextColor="White"
                                   FontSize="14"
                                   Opacity="0.9"/>
                            <Label Text="{Binding DespesasMesFormatado}"
                                   TextColor="White"
                                   FontSize="22"
                                   FontAttributes="Bold"/>
                            <Label Text="-8% vs mês anterior"
                                   TextColor="White"
                                   FontSize="11"
                                   Opacity="0.7"/>
                        </VerticalStackLayout>
                    </Frame>
                </Grid>

                <!-- Gráfico: Receitas vs Despesas -->
                <Frame CornerRadius="20"
                       Padding="20"
                       HasShadow="True"
                       BackgroundColor="White">
                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="8">
                            <Label Text="📊" FontSize="24"/>
                            <Label Text="Últimos 6 Meses"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>

                        <lvc:CartesianChart Series="{Binding ReceitasDespesasSeries}"
                                           XAxes="{Binding XAxes}"
                                           YAxes="{Binding YAxes}"
                                           HeightRequest="280"
                                           TooltipPosition="Top"
                                           AnimationsSpeed="00:00:00.8"/>
                    </VerticalStackLayout>
                </Frame>

                <!-- Gráfico: Gastos por Categoria -->
                <Frame CornerRadius="20"
                       Padding="20"
                       HasShadow="True"
                       BackgroundColor="White">
                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="8">
                            <Label Text="🍕" FontSize="24"/>
                            <Label Text="Gastos por Categoria"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>

                        <lvc:PieChart Series="{Binding GastosPorCategoriaSeries}"
                                     HeightRequest="280"
                                     InitialRotation="-90"
                                     AnimationsSpeed="00:00:00.8"/>

                        <!-- Legenda Melhorada -->
                        <BoxView HeightRequest="1"
                                Color="#E5E5EA"
                                Margin="0,8"/>

                        <CollectionView ItemsSource="{Binding GastosPorCategoria}">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="12"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="vm:CategoryExpense">
                                    <Grid ColumnDefinitions="24,*,Auto" ColumnSpacing="12">
                                        <BoxView Grid.Column="0"
                                                Color="{Binding Color}"
                                                WidthRequest="20"
                                                HeightRequest="20"
                                                CornerRadius="6"
                                                VerticalOptions="Center"/>
                                        <Label Grid.Column="1"
                                              Text="{Binding CategoryName}"
                                              FontSize="15"
                                              VerticalOptions="Center"/>
                                        <Label Grid.Column="2"
                                              Text="{Binding AmountFormatted}"
                                              FontSize="15"
                                              FontAttributes="Bold"
                                              TextColor="#1C1C1E"
                                              VerticalOptions="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Gráfico: Tendência de Saldo -->
                <Frame CornerRadius="20"
                       Padding="20"
                       HasShadow="True"
                       BackgroundColor="White">
                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="8">
                            <Label Text="📈" FontSize="24"/>
                            <Label Text="Tendência de Saldo"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                        <Label Text="Últimos 30 dias"
                               FontSize="14"
                               TextColor="#8E8E93"
                               Margin="0,-8,0,0"/>

                        <lvc:CartesianChart Series="{Binding TendenciaSaldoSeries}"
                                           XAxes="{Binding TrendXAxes}"
                                           YAxes="{Binding TrendYAxes}"
                                           HeightRequest="220"
                                           AnimationsSpeed="00:00:00.8"/>
                    </VerticalStackLayout>
                </Frame>

                <!-- Minhas Contas -->
                <Frame CornerRadius="20"
                       Padding="20"
                       HasShadow="True"
                       BackgroundColor="White">
                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="12">
                            <Label Text="💳" FontSize="24"/>
                            <Label Text="Minhas Contas"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Start"/>
                            <Frame BackgroundColor="#F2F2F7"
                                   Padding="8,4"
                                   CornerRadius="8"
                                   HasShadow="False"
                                   VerticalOptions="Center">
                                <Label Text="{Binding Contas.Count}"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       TextColor="#667eea"/>
                            </Frame>
                        </HorizontalStackLayout>

                        <CollectionView ItemsSource="{Binding Contas}">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="12"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Conta">
                                    <Frame Padding="16"
                                          CornerRadius="16"
                                          BackgroundColor="#F9F9FB"
                                          HasShadow="False">
                                        <Grid ColumnDefinitions="48,*,Auto" ColumnSpacing="16">
                                            <!-- Ícone -->
                                            <Frame Grid.Column="0"
                                                  WidthRequest="48"
                                                  HeightRequest="48"
                                                  CornerRadius="12"
                                                  Padding="0"
                                                  HasShadow="False"
                                                  BackgroundColor="#667eea">
                                                <Label Text="{Binding TipoIcone}"
                                                      FontSize="24"
                                                      HorizontalOptions="Center"
                                                      VerticalOptions="Center"/>
                                            </Frame>

                                            <!-- Info -->
                                            <VerticalStackLayout Grid.Column="1"
                                                                Spacing="4"
                                                                VerticalOptions="Center">
                                                <Label Text="{Binding Nome}"
                                                      FontSize="16"
                                                      FontAttributes="Bold"
                                                      TextColor="#1C1C1E"/>
                                                <Label Text="{Binding TipoConta}"
                                                      FontSize="13"
                                                      TextColor="#8E8E93"/>
                                            </VerticalStackLayout>

                                            <!-- Saldo -->
                                            <Label Grid.Column="2"
                                                  Text="{Binding SaldoFormatado}"
                                                  FontSize="18"
                                                  FontAttributes="Bold"
                                                  TextColor="#667eea"
                                                  VerticalOptions="Center"/>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Loading Indicator -->
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                  IsVisible="{Binding IsLoading}"
                                  Color="#667eea"
                                  HeightRequest="60"
                                  Margin="0,20"/>

                <!-- Footer -->
                <Label Text="Última atualização: agora"
                       FontSize="12"
                       TextColor="#AEAEB2"
                       HorizontalOptions="Center"
                       Margin="0,0,0,20"/>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
