<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Orcamento.ViewModels"
             xmlns:models="clr-namespace:Orcamento.Models"
             x:Class="Orcamento.Views.OrcamentosPage"
             x:DataType="vm:OrcamentosViewModel"
             Title="Orçamentos"
             BackgroundColor="#F5F5F7">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Novo"
                     IconImageSource="add.png"
                     Command="{Binding NovoOrcamentoCommand}"/>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,*">

        <!-- Header -->
        <Frame Grid.Row="0"
               Margin="20,20,20,0"
               Padding="24"
               CornerRadius="20"
               HasShadow="True">
            <VerticalStackLayout Spacing="12">
                <Label Text="📊 Orçamento do Mês"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="#1C1C1E"/>

                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                    <VerticalStackLayout Grid.Column="0" Spacing="4">
                        <Label Text="{Binding MesAtual}"
                               FontSize="14"
                               TextColor="#8E8E93"/>
                        <Label Text="{Binding TotalGastoFormatado}"
                               FontSize="28"
                               FontAttributes="Bold"
                               TextColor="#1C1C1E"/>
                    </VerticalStackLayout>

                    <VerticalStackLayout Grid.Column="1" Grid.RowSpan="2"
                                        VerticalOptions="Center"
                                        Spacing="4">
                        <Label Text="de"
                               FontSize="12"
                               TextColor="#8E8E93"
                               HorizontalOptions="End"/>
                        <Label Text="{Binding TotalPlanejadoFormatado}"
                               FontSize="20"
                               FontAttributes="Bold"
                               TextColor="#667eea"
                               HorizontalOptions="End"/>
                    </VerticalStackLayout>

                    <ProgressBar Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1"
                                Progress="{Binding PercentualGasto}"
                                ProgressColor="{Binding CorProgresso}"
                                HeightRequest="8"
                                Margin="0,12,0,0"/>
                </Grid>

                <Label Text="{Binding StatusOrcamento}"
                       FontSize="13"
                       TextColor="{Binding CorStatus}"
                       Margin="0,4,0,0"/>
            </VerticalStackLayout>
        </Frame>

        <!-- Lista de Orçamentos -->
        <RefreshView Grid.Row="1"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}"
                     RefreshColor="#667eea"
                     Margin="20,16,20,20">
            <CollectionView ItemsSource="{Binding Orcamentos}">
                <CollectionView.EmptyView>
                    <VerticalStackLayout Padding="40"
                                        Spacing="16"
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center">
                        <Label Text="📊"
                               FontSize="80"
                               HorizontalOptions="Center"/>
                        <Label Text="Nenhum orçamento definido"
                               FontSize="20"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               TextColor="#1C1C1E"/>
                        <Label Text="Defina limites de gastos para cada categoria e controle melhor suas finanças"
                               FontSize="14"
                               HorizontalOptions="Center"
                               TextColor="#8E8E93"
                               HorizontalTextAlignment="Center"
                               MaximumWidthRequest="300"/>
                        <Button Text="➕ Criar Orçamento"
                                Command="{Binding NovoOrcamentoCommand}"
                                BackgroundColor="#667eea"
                                TextColor="White"
                                CornerRadius="12"
                                Padding="24,12"
                                Margin="0,16,0,0"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="12"/>
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:OrcamentoMensal">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Editar"
                                              BackgroundColor="#667eea"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OrcamentosViewModel}}, Path=EditarOrcamentoCommand}"
                                              CommandParameter="{Binding .}"/>
                                    <SwipeItem Text="Excluir"
                                              BackgroundColor="#FF3B30"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type vm:OrcamentosViewModel}}, Path=ExcluirOrcamentoCommand}"
                                              CommandParameter="{Binding .}"/>
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <Frame Padding="20"
                                   CornerRadius="16"
                                   HasShadow="True"
                                   BackgroundColor="White">
                                <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="12">

                                    <!-- Categoria e Valor -->
                                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                                        <Label Grid.Column="0"
                                              Text="{Binding Categoria}"
                                              FontSize="18"
                                              FontAttributes="Bold"
                                              TextColor="#1C1C1E"/>
                                        <Label Grid.Column="1"
                                              Text="{Binding ValorPlanejadoFormatado}"
                                              FontSize="18"
                                              FontAttributes="Bold"
                                              TextColor="#667eea"/>
                                    </Grid>

                                    <!-- Barra de Progresso -->
                                    <VerticalStackLayout Grid.Row="1" Spacing="8">
                                        <ProgressBar Progress="{Binding PercentualGasto}"
                                                    ProgressColor="{Binding CorBarra}"
                                                    HeightRequest="8"/>
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Grid.Column="0"
                                                  Text="{Binding GastoFormatado}"
                                                  FontSize="14"
                                                  TextColor="#8E8E93"/>
                                            <Label Grid.Column="1"
                                                  Text="{Binding PercentualTexto}"
                                                  FontSize="14"
                                                  FontAttributes="Bold"
                                                  TextColor="{Binding CorBarra}"/>
                                        </Grid>
                                    </VerticalStackLayout>

                                    <!-- Status -->
                                    <HorizontalStackLayout Grid.Row="2" Spacing="8">
                                        <Frame Padding="8,4"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               BackgroundColor="{Binding CorStatusBg}">
                                            <Label Text="{Binding Status}"
                                                   FontSize="11"
                                                   FontAttributes="Bold"
                                                   TextColor="{Binding CorStatusText}"/>
                                        </Frame>

                                        <Label Text="{Binding SaldoRestante}"
                                               FontSize="12"
                                               TextColor="#8E8E93"
                                               VerticalOptions="Center"/>
                                    </HorizontalStackLayout>

                                </Grid>
                            </Frame>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Loading -->
        <ActivityIndicator Grid.Row="1"
                          IsRunning="{Binding IsLoading}"
                          IsVisible="{Binding IsLoading}"
                          Color="#667eea"
                          HeightRequest="60"/>

        <!-- Botão Flutuante -->
        <Button Grid.Row="1"
                Text="➕"
                FontSize="32"
                WidthRequest="64"
                HeightRequest="64"
                CornerRadius="32"
                BackgroundColor="#667eea"
                TextColor="White"
                Command="{Binding NovoOrcamentoCommand}"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="0,0,20,20"/>
    </Grid>
</ContentPage>
