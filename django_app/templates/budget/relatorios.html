{% extends 'base.html' %}
{% load budget_filters %}

{% block title %}Relat√≥rios - Budget{% endblock %}

{% block content %}
<div class="header-section">
    <div class="header-content">
        <h1>üìä Relat√≥rios Financeiros</h1>
        <div class="header-actions">
            <a href="{% url 'exportar_transacoes' %}?inicio={{ data_inicio|date:'Y-m-d' }}&fim={{ data_fim|date:'Y-m-d' }}" class="btn btn-outline">
                üì• Exportar Transa√ß√µes
            </a>
            <a href="{% url 'exportar_orcamentos' %}" class="btn btn-outline">
                üì• Exportar Or√ßamentos
            </a>
        </div>
    </div>

    <form method="get" class="filter-form">
        <div class="form-row">
            <div class="form-group">
                <label>Data In√≠cio:</label>
                <input type="date" name="inicio" value="{{ data_inicio|date:'Y-m-d' }}" class="form-control">
            </div>
            <div class="form-group">
                <label>Data Fim:</label>
                <input type="date" name="fim" value="{{ data_fim|date:'Y-m-d' }}" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary">üîç Filtrar</button>
        </div>
    </form>
</div>

<!-- Resumo Geral -->
<div class="cards-grid">
    <div class="card stat-card receita">
        <div class="stat-value">R$ {{ resumo.receitas.total|floatformat:2 }}</div>
        <div class="stat-label">üí∞ Total Receitas</div>
        <div class="stat-meta">{{ resumo.receitas.quantidade }} transa√ß√µes</div>
    </div>

    <div class="card stat-card despesa">
        <div class="stat-value">R$ {{ resumo.despesas.total|floatformat:2 }}</div>
        <div class="stat-label">üí∏ Total Despesas</div>
        <div class="stat-meta">{{ resumo.despesas.quantidade }} transa√ß√µes</div>
    </div>

    <div class="card stat-card {% if resumo.balanco >= 0 %}receita{% else %}despesa{% endif %}">
        <div class="stat-value">R$ {{ resumo.balanco|floatformat:2 }}</div>
        <div class="stat-label">üìà Balan√ßo</div>
        <div class="stat-meta">{{ data_inicio|date:"d/m/Y" }} - {{ data_fim|date:"d/m/Y" }}</div>
    </div>

    <div class="card stat-card">
        <div class="stat-value">R$ {{ resumo.saldo_atual|floatformat:2 }}</div>
        <div class="stat-label">üíµ Saldo Atual</div>
        <div class="stat-meta">Todas as contas</div>
    </div>
</div>

<!-- Tend√™ncia de Gastos -->
<div class="card">
    <h2>üìâ Tend√™ncia de Gastos (√∫ltimos 30 dias)</h2>
    <div class="tendencia-info">
        <div class="info-item">
            <strong>M√©dia Di√°ria:</strong> R$ {{ tendencia.media_diaria|floatformat:2 }}
        </div>
        <div class="info-item">
            <strong>Tend√™ncia:</strong>
            <span class="badge {% if tendencia.tendencia == 'crescente' %}badge-danger{% elif tendencia.tendencia == 'decrescente' %}badge-success{% else %}badge-info{% endif %}">
                {% if tendencia.tendencia == 'crescente' %}üìà Crescente{% elif tendencia.tendencia == 'decrescente' %}üìâ Decrescente{% else %}‚û°Ô∏è Est√°vel{% endif %}
            </span>
        </div>
        <div class="info-item">
            <strong>Varia√ß√£o:</strong> {{ tendencia.variacao_percentual|floatformat:2 }}%
        </div>
    </div>
</div>

<!-- Fluxo Mensal -->
<div class="card">
    <h2>üíπ Fluxo de Caixa Mensal</h2>
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>M√™s</th>
                    <th>Receitas</th>
                    <th>Despesas</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% for mes in fluxo_mensal %}
                <tr>
                    <td><strong>{{ mes.mes }}</strong></td>
                    <td class="text-success">R$ {{ mes.receitas|floatformat:2 }}</td>
                    <td class="text-danger">R$ {{ mes.despesas|floatformat:2 }}</td>
                    <td class="{% if mes.saldo >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>R$ {{ mes.saldo|floatformat:2 }}</strong>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center">Nenhum dado no per√≠odo selecionado</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Por Categoria -->
<div class="cards-grid-2">
    <div class="card">
        <h2>üè∑Ô∏è Por Categoria (Despesas)</h2>
        <div class="categoria-list">
            {% for cat in por_categoria %}
            {% if cat.tipo == 'despesa' %}
            <div class="categoria-item">
                <div class="categoria-info">
                    <span class="categoria-icon">{{ cat.icone }}</span>
                    <span class="categoria-nome">{{ cat.categoria }}</span>
                </div>
                <div class="categoria-valor">
                    <strong>R$ {{ cat.total|floatformat:2 }}</strong>
                    <small>{{ cat.quantidade }} transa√ß√µes</small>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="card">
        <h2>üíµ Por Categoria (Receitas)</h2>
        <div class="categoria-list">
            {% for cat in por_categoria %}
            {% if cat.tipo == 'receita' %}
            <div class="categoria-item">
                <div class="categoria-info">
                    <span class="categoria-icon">{{ cat.icone }}</span>
                    <span class="categoria-nome">{{ cat.categoria }}</span>
                </div>
                <div class="categoria-valor text-success">
                    <strong>R$ {{ cat.total|floatformat:2 }}</strong>
                    <small>{{ cat.quantidade }} transa√ß√µes</small>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Performance de Or√ßamentos -->
{% if orcamentos %}
<div class="card">
    <h2>üéØ Performance dos Or√ßamentos (M√™s Atual)</h2>
    <div class="orcamentos-performance">
        {% for orc in orcamentos %}
        <div class="orcamento-item">
            <div class="orcamento-header">
                <span class="categoria-icon">{{ orc.icone }}</span>
                <span class="categoria-nome">{{ orc.categoria }}</span>
                <span class="badge badge-{{ orc.status }}">
                    {% if orc.status == 'normal' %}‚úÖ Normal
                    {% elif orc.status == 'atencao' %}‚ö†Ô∏è Aten√ß√£o
                    {% elif orc.status == 'critico' %}üî¥ Cr√≠tico
                    {% else %}‚ùå Excedido{% endif %}
                </span>
            </div>
            <div class="progress-container">
                <div class="progress-bar progress-{{ orc.status }}" style="width: {{ orc.percentual|floatformat:0 }}%"></div>
            </div>
            <div class="orcamento-valores">
                <span>Gasto: <strong>R$ {{ orc.gasto|floatformat:2 }}</strong></span>
                <span>Limite: R$ {{ orc.limite|floatformat:2 }}</span>
                <span>{{ orc.percentual|floatformat:1 }}%</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Top Despesas -->
<div class="card">
    <h2>üîù Top 10 Maiores Despesas</h2>
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descri√ß√£o</th>
                    <th>Categoria</th>
                    <th>Conta</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody>
                {% for despesa in top_despesas %}
                <tr>
                    <td>{{ despesa.data }}</td>
                    <td><strong>{{ despesa.descricao }}</strong></td>
                    <td>{{ despesa.categoria }}</td>
                    <td>{{ despesa.conta }}</td>
                    <td class="text-danger"><strong>R$ {{ despesa.valor|floatformat:2 }}</strong></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">Nenhuma despesa no per√≠odo</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Por Conta -->
<div class="card">
    <h2>üè¶ Movimenta√ß√£o por Conta</h2>
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Conta</th>
                    <th>Tipo</th>
                    <th>Receitas</th>
                    <th>Despesas</th>
                    <th>Transa√ß√µes</th>
                    <th>Saldo Atual</th>
                </tr>
            </thead>
            <tbody>
                {% for conta in por_conta %}
                <tr>
                    <td><strong>{{ conta.conta }}</strong></td>
                    <td>{{ conta.tipo }}</td>
                    <td class="text-success">R$ {{ conta.receitas|floatformat:2 }}</td>
                    <td class="text-danger">R$ {{ conta.despesas|floatformat:2 }}</td>
                    <td>{{ conta.transacoes }}</td>
                    <td><strong>R$ {{ conta.saldo_atual|floatformat:2 }}</strong></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">Nenhuma conta encontrada</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.header-section {
    margin-bottom: 2rem;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

.filter-form {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-row {
    display: flex;
    gap: 1rem;
    align-items: end;
}

.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.cards-grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    text-align: center;
    padding: 2rem 1rem;
}

.stat-card.receita {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.stat-card.despesa {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 1rem;
    opacity: 0.9;
    margin-bottom: 0.25rem;
}

.stat-meta {
    font-size: 0.875rem;
    opacity: 0.8;
}

.tendencia-info {
    display: flex;
    justify-content: space-around;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 1rem;
}

.info-item {
    text-align: center;
}

.categoria-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
}

.categoria-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.categoria-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.categoria-icon {
    font-size: 1.5rem;
}

.categoria-nome {
    font-weight: 500;
}

.categoria-valor {
    text-align: right;
}

.categoria-valor small {
    display: block;
    color: #666;
    font-size: 0.875rem;
}

.orcamentos-performance {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 1rem;
}

.orcamento-item {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.orcamento-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.orcamento-valores {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    color: #666;
}

.progress-container {
    height: 12px;
    background: #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    transition: width 0.3s ease;
}

.progress-normal { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
.progress-atencao { background: linear-gradient(90deg, #FF9800, #FFC107); }
.progress-critico { background: linear-gradient(90deg, #FF5722, #F44336); }
.progress-excedido { background: linear-gradient(90deg, #C62828, #B71C1C); }

.badge-normal { background: #4CAF50; }
.badge-atencao { background: #FF9800; }
.badge-critico { background: #FF5722; }
.badge-excedido { background: #C62828; }

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}

.data-table thead th {
    background: #f8f9fa;
    font-weight: 600;
}

.data-table tbody tr:hover {
    background: #f8f9fa;
}

.text-success { color: #4CAF50 !important; }
.text-danger { color: #F44336 !important; }
.text-center { text-align: center; }

.table-responsive {
    overflow-x: auto;
}
</style>
{% endblock %}
