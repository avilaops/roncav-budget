name: Build, Test and Deploy Roncav Budget

on:
    push:
        branches: [main, master]
        tags:
            - 'v*'
    pull_request:
        branches: [main, master]
    workflow_dispatch:

env:
    AVILA_API_BASE_URL: "https://api.avila.inc/v1/"
    PORTAL_URL: "https://portal.avila.inc/"
    AVILA_PULSE_URL: "https://api.avila.inc/pulse"

jobs:
    build-windows:
        runs-on: windows-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET SDK
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "9.0.x"

            - name: Install MAUI Workloads
              run: dotnet workload install maui-windows

            - name: Restore NuGet packages
              run: dotnet restore Roncav_Budget.winui/Roncav_Budget.winui.csproj

            - name: Build WinUI project
              run: dotnet build Roncav_Budget.winui/Roncav_Budget.winui.csproj -c Release -p:Platform=x64 /nologo

            - name: Publish WinUI package
              run: dotnet publish Roncav_Budget.winui/Roncav_Budget.winui.csproj -c Release -p:Platform=x64 -o output/winui

            - name: Compress WinUI artifact
              run: |
                  if (!(Test-Path artifacts)) { New-Item -Path artifacts -ItemType Directory | Out-Null }
                  Compress-Archive -Path output/winui/* -DestinationPath artifacts/RoncavBudget-Windows-x64.zip

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: RoncavBudget-Windows-x64
                  path: artifacts/RoncavBudget-Windows-x64.zip
                  retention-days: 30

    build-android:
        runs-on: windows-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup .NET SDK
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "9.0.x"

            - name: Install MAUI Workloads
              run: dotnet workload install maui-android

            - name: Restore NuGet packages
              run: dotnet restore Roncav_Budget.droid/Roncav_Budget.droid.csproj

            - name: Build Android APK
              run: dotnet publish Roncav_Budget.droid/Roncav_Budget.droid.csproj -c Release -f net9.0-android -p:AndroidPackageFormat=apk -o output/android

            - name: Find and copy APK
              run: |
                  if (!(Test-Path artifacts)) { New-Item -Path artifacts -ItemType Directory | Out-Null }
                  $apkFiles = Get-ChildItem -Path output/android -Filter *.apk -Recurse
                  if ($apkFiles.Count -gt 0) {
                      Copy-Item $apkFiles[0].FullName artifacts/RoncavBudget-Android.apk
                      Write-Host "APK copiado: $($apkFiles[0].Name)"
                  } else {
                      Write-Warning "Nenhum APK encontrado"
                      exit 1
                  }

            - name: Upload APK artifact
              uses: actions/upload-artifact@v4
              with:
                  name: RoncavBudget-Android-APK
                  path: artifacts/RoncavBudget-Android.apk
                  retention-days: 30

    deploy-docs:
        runs-on: ubuntu-22.04
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        permissions:
            contents: write
            pages: write
            id-token: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Pages
              uses: actions/configure-pages@v4

            - name: Create documentation site
              run: |
                  mkdir -p _site
                  
                  # Copy markdown files if they exist
                  if [ -d "docs" ] && [ -n "$(ls -A docs/*.md 2>/dev/null)" ]; then
                      cp docs/*.md _site/ 2>/dev/null || true
                  fi
                  
                  # Create index.html
                  cat > _site/index.html << 'EOF'
                  <!DOCTYPE html>
                  <html lang="pt-BR">
                  <head>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <title>Roncav Budget - Documenta√ß√£o</title>
                      <style>
                          body { 
                              font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                              max-width: 1200px; 
                              margin: 0 auto; 
                              padding: 20px;
                              line-height: 1.6;
                              color: #333;
                          }
                          h1 { color: #1E88E5; border-bottom: 3px solid #1E88E5; padding-bottom: 10px; }
                          .card { 
                              background: #f8f9fa; 
                              padding: 20px; 
                              margin: 15px 0; 
                              border-radius: 8px;
                              border-left: 4px solid #1E88E5;
                          }
                          .card h2 { margin-top: 0; color: #1E88E5; }
                          a { color: #1E88E5; text-decoration: none; }
                          a:hover { text-decoration: underline; }
                          .btn {
                              display: inline-block;
                              padding: 10px 20px;
                              background: #1E88E5;
                              color: white;
                              border-radius: 5px;
                              margin: 10px 5px 10px 0;
                          }
                          .btn:hover { background: #1565C0; text-decoration: none; }
                          footer { 
                              margin-top: 40px; 
                              padding-top: 20px; 
                              border-top: 1px solid #ddd;
                              text-align: center;
                              color: #666;
                          }
                      </style>
                  </head>
                  <body>
                      <h1>üè¶ Roncav Budget - Documenta√ß√£o</h1>
                      <p>Aplicativo de gest√£o financeira multiplataforma para o mercado brasileiro.</p>
                      
                      <div class="card">
                          <h2>üì• Downloads</h2>
                          <p>Baixe a vers√£o mais recente do Roncav Budget:</p>
                          <a href="https://github.com/avilaops/roncav-budget/releases/latest" class="btn">üì¶ Releases</a>
                          <a href="https://github.com/avilaops/roncav-budget/actions" class="btn">üîß Builds</a>
                      </div>
                      
                      <div class="card">
                          <h2>üìö Documenta√ß√£o</h2>
                          <ul>
                              <li><a href="RESUMO_EXECUTIVO.html">Resumo Executivo</a></li>
                              <li><a href="IMPLEMENTACAO_STATUS.html">Status de Implementa√ß√£o</a></li>
                              <li><a href="AVILA_INTEGRATION.html">Integra√ß√£o Avila</a></li>
                              <li><a href="DEPLOYMENT_AND_SYNC.html">Deploy e Sincroniza√ß√£o</a></li>
                              <li><a href="LANDING_PAGE.html">Landing Page</a></li>
                              <li><a href="MARKETING_STRATEGY.html">Estrat√©gia de Marketing</a></li>
                          </ul>
                      </div>
                      
                      <div class="card">
                          <h2>üöÄ In√≠cio R√°pido</h2>
                          <pre><code>git clone https://github.com/avilaops/roncav-budget.git
                  cd roncav-budget
                  dotnet restore
                  dotnet build</code></pre>
                      </div>
                      
                      <div class="card">
                          <h2>üîó Links √öteis</h2>
                          <ul>
                              <li><a href="https://github.com/avilaops/roncav-budget">Reposit√≥rio GitHub</a></li>
                              <li><a href="https://github.com/avilaops/roncav-budget/issues">Issues</a></li>
                              <li><a href="https://github.com/avilaops/roncav-budget/pulls">Pull Requests</a></li>
                          </ul>
                      </div>
                      
                      <footer>
                          <p>Roncav Budget ¬© 2025 - Desenvolvido com ‚ù§Ô∏è para o mercado brasileiro</p>
                      </footer>
                  </body>
                  </html>
                  EOF
                  
                  # Convert markdown files to HTML
                  for file in _site/*.md; do
                      [ -f "$file" ] || continue
                      filename=$(basename "$file" .md)
                      cat > "_site/${filename}.html" << EOF
                  <!DOCTYPE html>
                  <html lang="pt-BR">
                  <head>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <title>${filename} - Roncav Budget</title>
                      <style>
                          body { 
                              font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                              max-width: 900px; 
                              margin: 0 auto; 
                              padding: 20px;
                              line-height: 1.6;
                          }
                          pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
                          code { background: #f5f5f5; padding: 2px 5px; border-radius: 3px; }
                          a { color: #1E88E5; }
                      </style>
                  </head>
                  <body>
                      <a href="index.html">‚Üê Voltar</a>
                      <pre>$(cat "$file")</pre>
                  </body>
                  </html>
                  EOF
                  done

            - name: Upload Pages artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: _site

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

    release:
        runs-on: ubuntu-22.04
        needs: [build-windows, build-android]
        if: startsWith(github.ref, 'refs/tags/v')
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download Windows artifact
              uses: actions/download-artifact@v4
              with:
                  name: RoncavBudget-Windows-x64
                  path: release

            - name: Download Android artifact
              uses: actions/download-artifact@v4
              with:
                  name: RoncavBudget-Android-APK
                  path: release

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      release/RoncavBudget-Windows-x64.zip
                      release/RoncavBudget-Android.apk
                  body: |
                      ## üéâ Roncav Budget ${{ github.ref_name }}
                      
                      ### üì¶ Downloads
                      
                      **Windows (WinUI 3)**
                      - `RoncavBudget-Windows-x64.zip` - Aplicativo Windows completo
                      
                      **Android**
                      - `RoncavBudget-Android.apk` - APK para instala√ß√£o direta
                      
                      ### üöÄ Instala√ß√£o
                      
                      **Windows:**
                      1. Baixe `RoncavBudget-Windows-x64.zip`
                      2. Extraia o arquivo ZIP
                      3. Execute `Roncav_Budget.winui.exe`
                      
                      **Android:**
                      1. Baixe `RoncavBudget-Android.apk`
                      2. Habilite "Instalar de fontes desconhecidas"
                      3. Instale o APK
                      
                      ### üìö Documenta√ß√£o
                      
                      Acesse a documenta√ß√£o completa em: https://avilaops.github.io/roncav-budget
                      
                      ---
                      
                      **Data de lan√ßamento:** ${{ github.event.head_commit.timestamp }}
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
